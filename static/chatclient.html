<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>viewer</title>
<style>
.enjoy-css {
  -webkit-box-sizing: content-box;
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  margin: 0 50% 0 0;
  padding: 10px;
  border: none;
  -webkit-border-radius: 11px;
  border-radius: 11px;
  font: normal 16px/1 "Comic Sans MS", cursive, sans-serif;
  color: black;
  text-indent: 10px;
  -o-text-overflow: ellipsis;
  text-overflow: ellipsis;
  background: #fff5d1;
  text-shadow: 4px 4px 6px rgba(0,0,0,0.5) ;
}
#ReloadThis {
  overflow: auto;
   max-height: 50vh;
}
</style>
<script src="chatDisplay.js"></script>
</head>
<body  onLoad="loaduid()">
<div id="ReloadThis" ></div>
<hr>
<form id='myForm'>
  User Name: <input type="text" name="uid" id="uid"><br>
  Message: <textarea id="idmsg" type="text" name="msg"  cols="40" rows="5" ></textarea>
</form>
<button onclick="sendMessage();">send message</button>
<script type="text/javascript">
var lastMsg=0;
function saveuid() {
	var fieldValue = document.getElementById('uid').value;
	localStorage.setItem('textuid', fieldValue);
}

function loaduid() {
	var storedValue = localStorage.getItem('textuid');
	if(storedValue) {
		document.getElementById('uid').value = storedValue;
	}
}

function clearField(){
  document.forms[0].msg.value = "";
}

var xmlhttp = [];
var cd = new ChatDisplay('ReloadThis');
function ajaxGet(requestedUrl, callbackFunction, channel){
	if (window.XMLHttpRequest){
		// code for IE7+, Firefox, Chrome, Opera, Safari
		xmlhttp[channel]=new XMLHttpRequest();
	}
	else{
		// code for IE6, IE5
		xmlhttp[channel]=new ActiveXObject("Microsoft.XMLHTTP");
	}
	xmlhttp[channel].onreadystatechange=callbackFunction;
	xmlhttp[channel].open("GET",requestedUrl,true);
	xmlhttp[channel].send();
}

function getMessages(){
  uid = document.getElementById('uid').value;
	ajaxGet("../chat?action=get&uid=" + uid +'&lastMsg=' + lastMsg,function(){
		if (xmlhttp[0].readyState==4 && xmlhttp[0].status==200){
      messages=JSON.parse(xmlhttp[0].responseText);
      cd.update(xmlhttp[0].responseText);
      console.log(messages);
      if(messages.length>0){
        lastMsg =  parseInt(messages[messages.length -1]['msgIndex']);
      }

      var elem = document.getElementById('ReloadThis');
      elem.scrollTop = elem.scrollHeight;
      setTimeout('getMessages()',8000);
		}
	},0);
}

function sendMessage(){
  var msg = document.getElementById('idmsg').value;
  if(msg!=''){
    saveuid();
    var uid = document.getElementById('uid').value;
    ajaxGet('../chat?action=send&uid=' +  uid + '&msg=' + msg,function(){
          if (xmlhttp[0].readyState==4 && xmlhttp[0].status==200){
            clearField();
          }
    },1);
  }
}

window.onload=function(){
	setTimeout('getMessages()',3000);
}
</script>
</body>
</html>